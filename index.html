<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sukelluspöytäkirja</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Light mode (default) */
        body[data-theme="light"] {
            background-color: #ffffff;
            color: #000000;
        }

        /* Dark mode */
        body[data-theme="dark"] {
            background-color: #343a40;
            color: #ffffff;
        }
        body[data-theme="dark"] .container,
        body[data-theme="dark"] .modal-content,
        body[data-theme="dark"] .list-group-item,
        body[data-theme="dark"] .form-control,
        body[data-theme="dark"] .btn-light {
            background-color: #495057;
            color: #ffffff;
            border-color: #6c757d;
        }
        body[data-theme="dark"] .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        body[data-theme="dark"] .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        body[data-theme="dark"] .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        body[data-theme="dark"] .btn-info {
            background-color: #17a2b8;
            border-color: #17a2b8;
        }
        body[data-theme="dark"] .form-control:focus {
            background-color: #495057;
            color: #ffffff;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
        }
        body[data-theme="dark"] .modal-content {
            border-color: #6c757d;
        }

        /* Existing styles */
        body { padding: 20px; }
        .dive-time { color: green; font-size: 1.6em; }
        .dive-time-warning { color: orange; font-size: 1.6em; }
        .dive-time-over { color: red; font-size: 1.8em; }
        .diver-row { margin-bottom: 10px; }
        .trash-icon, .play-icon, .pause-icon, .resume-icon, .stop-icon {
            cursor: pointer;
            margin-left: 10px;
            font-size: 2em; /* Action buttons at 2em */
        }
        .event-header { margin-bottom: 20px; }
        .font-weight-bold { font-weight: bold; }
        .mb-2 { margin-bottom: 0.5rem; }
        .input-span { cursor: pointer; text-decoration: underline; }
        .buddy-checkboxes { max-height: 100px; overflow-y: auto; }
        #mixedGasInput { display: none; }
        #themeToggleContainer { margin-top: 20px; }
        .required-label::after {
            content: ' *';
            color: red;
        }
        .required-note {
            font-size: 0.9em;
            color: red;
        }
    </style>
</head>
<body data-theme="light">
    <!-- Main View -->
    <div id="mainView" class="container">
        <h1>Sukelluspöytäkirja</h1>
        <button class="btn btn-primary mb-3" onclick="showNewEventForm()">Uusi Tapahtuma</button>
        <button class="btn btn-info mb-3" onclick="backupEvents()">Varmuuskopioi</button>
        <label class="btn btn-secondary mb-3">
            Palauta <input type="file" id="restoreInput" accept=".json" onchange="restoreEvents(event)" style="display: none;">
        </label>
        <h3>Aiemmat Tapahtumat</h3>
        <ul id="eventList" class="list-group"></ul>
        <div id="themeToggleContainer">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="themeToggle" onchange="toggleTheme()">
                <label class="form-check-label" for="themeToggle">Tumma tila</label>
            </div>
        </div>
    </div>

    <!-- New Event Form -->
    <div id="newEventForm" class="container" style="display: none;">
        <h2>Luo Uusi Tapahtuma</h2>
        <form id="eventForm">
            <div class="mb-3">
                <label for="location" class="form-label">Sijainti</label>
                <input type="text" class="form-control" id="location" required>
            </div>
            <div class="mb-3">
                <label for="diveMaster" class="form-label">Sukellusvanhin</label>
                <input type="text" class="form-control" id="diveMaster" required>
            </div>
            <button type="submit" class="btn btn-primary">Luo Tapahtuma</button>
            <button type="button" class="btn btn-secondary" onclick="showMainView()">Peruuta</button>
        </form>
    </div>

    <!-- Event View -->
    <div id="eventView" class="container" style="display: none;">
        <h2 id="eventTitle" class="event-header"></h2>
        <p><strong>Sukellusvanhin:</strong> <span id="eventDiveMaster"></span></p>
        <p><strong>Päivämäärä:</strong> <span id="eventDate"></span></p>
        <button class="btn btn-primary mb-3" onclick="showAddDiverForm()">Lisää Sukeltaja</button>
        <div id="diverList"></div>
        <button id="endEventBtn" class="btn btn-success mt-3" style="display: none;" onclick="endEvent()">Lopeta Tapahtuma</button>
        <button id="generatePdfBtn" class="btn btn-info mt-3" style="display: none;" onclick="generatePdf()">Luo PDF</button>
        <button class="btn btn-secondary mt-3" onclick="showMainView()">Takaisin Päänäkymään</button>
    </div>

    <!-- Add Diver Form -->
    <div id="addDiverForm" class="container" style="display: none;">
        <h2>Lisää Sukeltaja</h2>
        <form id="diverForm">
            <div class="mb-3">
                <label for="diverName" class="form-label">Sukeltajan Nimi</label>
                <input type="text" class="form-control" id="diverName" required>
            </div>
            <button type="submit" class="btn btn-primary">Lisää Sukeltaja</button>
            <button type="button" class="btn btn-secondary" onclick="showEventView()">Peruuta</button>
        </form>
    </div>

    <!-- Diver Details Modal -->
    <div class="modal fade" id="diverDetailsModal" tabindex="-1" aria-labelledby="diverDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="diverDetailsModalLabel">Syötä Sukeltajan Tiedot</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sulje"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="bottleSizeInput" class="form-label">Pullon koko (L)</label>
                        <input type="number" class="form-control" id="bottleSizeInput" placeholder="Pullon koko (L)" min="0">
                    </div>
                    <div class="mb-3">
                        <label for="pressureInput" class="form-label">Paine (bar)</label>
                        <input type="number" class="form-control" id="pressureInput" placeholder="Paine (bar)" min="0">
                    </div>
                    <div class="mb-3">
                        <label for="plannedDepthInput" class="form-label required-label">Suunniteltu syvyys (m)</label>
                        <input type="number" class="form-control" id="plannedDepthInput" placeholder="Suunniteltu syvyys (m)" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="plannedTimeInput" class="form-label required-label">Suunniteltu aika (min)</label>
                        <input type="number" class="form-control" id="plannedTimeInput" placeholder="Suunniteltu aika (min)" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label required-label">Kaasu</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="gasType" id="gasAir" value="Ilma" checked>
                            <label class="form-check-label" for="gasAir">Ilma</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="gasType" id="gasMixed" value="Seoskaasu">
                            <label class="form-check-label" for="gasMixed">Seoskaasu</label>
                        </div>
                        <input type="text" class="form-control mt-2" id="mixedGasInput" placeholder="Syötä seoskaasu (esim. Nitrox 32%)">
                    </div>
                    <div class="required-note">* Pakollinen</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Peruuta</button>
                    <button type="button" class="btn btn-primary" onclick="saveDiverDetails()">Tallenna</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Buddy Modal -->
    <div class="modal fade" id="buddyModal" tabindex="-1" aria-labelledby="buddyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="buddyModalLabel">Valitse Pari</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sulje"></button>
                </div>
                <div class="modal-body">
                    <div id="buddyCheckboxes" class="buddy-checkboxes"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Peruuta</button>
                    <button type="button" class="btn btn-primary" onclick="saveBuddies()">Tallenna</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notesModalLabel">Syötä Muistiinpanot</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sulje"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control" id="notesInput" placeholder="Muistiinpanot">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Peruuta</button>
                    <button type="button" class="btn btn-primary" onclick="saveNotes()">Tallenna</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Final Pressure Modal -->
    <div class="modal fade" id="finalPressureModal" tabindex="-1" aria-labelledby="finalPressureModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="finalPressureModalLabel">Syötä Lopullinen Paine</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sulje"></button>
                </div>
                <div class="modal-body">
                    <input type="number" class="form-control" id="finalPressureInput" placeholder="Lopullinen paine (bar)" min="0">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Peruuta</button>
                    <button type="button" class="btn btn-primary" onclick="saveFinalPressure()">Tallenna</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        let events = JSON.parse(localStorage.getItem('diveEvents')) || [];
        let currentEventId = null;
        let timers = {};
        let currentDiverId = null;

        // Theme handling
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            document.getElementById('themeToggle').checked = savedTheme === 'dark';
        }

        function toggleTheme() {
            const theme = document.getElementById('themeToggle').checked ? 'dark' : 'light';
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            console.log(`Switched to ${theme} mode`);
        }

        // Backup events to a JSON file
        function backupEvents() {
            console.log('Backing up events');
            const data = JSON.stringify(events, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sukelluspöytäkirja_backup.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log('Backup completed');
        }

        // Restore events from a JSON file
        function restoreEvents(event) {
            console.log('Restoring events');
            const file = event.target.files[0];
            if (!file) {
                console.error('No file selected');
                alert('Valitse JSON-tiedosto palauttaaksesi tapahtumat.');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const restoredEvents = JSON.parse(e.target.result);
                    if (!Array.isArray(restoredEvents)) {
                        throw new Error('Invalid JSON format: Not an array');
                    }
                    for (const evt of restoredEvents) {
                        if (!evt.id || !evt.location || !evt.diveMaster || !evt.date || !Array.isArray(evt.divers)) {
                            throw new Error('Invalid event structure');
                        }
                    }
                    events = restoredEvents;
                    localStorage.setItem('diveEvents', JSON.stringify(events));
                    loadEvents();
                    console.log('Events restored successfully');
                    alert('Tapahtumat palautettu onnistuneesti.');
                } catch (error) {
                    console.error('Error restoring events:', error);
                    alert('Virhe palautettaessa tapahtumia: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Show main view
        function showMainView() {
            console.log('Showing main view');
            document.getElementById('mainView').style.display = 'block';
            document.getElementById('newEventForm').style.display = 'none';
            document.getElementById('eventView').style.display = 'none';
            document.getElementById('addDiverForm').style.display = 'none';
            loadEvents();
        }

        // Show new event form
        function showNewEventForm() {
            console.log('Showing new event form');
            document.getElementById('mainView').style.display = 'none';
            document.getElementById('newEventForm').style.display = 'block';
            document.getElementById('eventView').style.display = 'none';
            document.getElementById('addDiverForm').style.display = 'none';
        }

        // Show event view
        function showEventView() {
            console.log('Showing event view for event ID:', currentEventId);
            document.getElementById('mainView').style.display = 'none';
            document.getElementById('newEventForm').style.display = 'none';
            document.getElementById('eventView').style.display = 'block';
            document.getElementById('addDiverForm').style.display = 'none';
            loadEventDetails();
        }

        // Show add diver form
        function showAddDiverForm() {
            console.log('Showing add diver form');
            document.getElementById('eventView').style.display = 'none';
            document.getElementById('addDiverForm').style.display = 'block';
        }

        // Load events in main view
        function loadEvents() {
            console.log('Loading events:', events);
            const eventList = document.getElementById('eventList');
            eventList.innerHTML = '';
            events.forEach(event => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `${event.location} - ${event.date} - ${event.diveMaster}
                    <span>
                        <button class="btn btn-sm btn-primary" onclick="openEvent('${event.id}')">Avaa</button>
                        <span class="trash-icon" onclick="confirmDeleteEvent('${event.id}')">🗑️</span>
                    </span>`;
                eventList.appendChild(li);
            });
        }

        // Confirm event deletion
        function confirmDeleteEvent(eventId) {
            if (confirm('Haluatko varmasti poistaa tämän tapahtuman?')) {
                events = events.filter(event => event.id !== eventId);
                localStorage.setItem('diveEvents', JSON.stringify(events));
                loadEvents();
            }
        }

        // Create new event
        document.getElementById('eventForm').addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Creating new event');
            const location = document.getElementById('location').value;
            const diveMaster = document.getElementById('diveMaster').value;
            const event = {
                id: Date.now().toString(),
                location,
                diveMaster,
                date: new Date().toLocaleDateString('fi-FI'),
                divers: [],
                ended: false
            };
            events.push(event);
            localStorage.setItem('diveEvents', JSON.stringify(events));
            currentEventId = event.id;
            showEventView();
        });

        // Open an event
        function openEvent(eventId) {
            console.log('Opening event:', eventId);
            currentEventId = eventId;
            showEventView();
        }

        // Confirm diver deletion
        function confirmDeleteDiver(diverId) {
            if (confirm('Haluatko varmasti poistaa tämän sukeltajan?')) {
                console.log('Deleting diver:', diverId);
                const event = events.find(e => e.id === currentEventId);
                event.divers = event.divers.filter(diver => {
                    if (diver.id === diverId) {
                        if (timers[diverId]) {
                            clearInterval(timers[diverId]);
                            delete timers[diverId];
                        }
                        return false;
                    }
                    if (diver.buddies.includes(diverId)) {
                        diver.buddies = diver.buddies.filter(id => id !== diverId);
                    }
                    return true;
                });
                localStorage.setItem('diveEvents', JSON.stringify(events));
                loadEventDetails();
            }
        }

        // Open diver details modal
        function openDiverDetailsModal(diverId) {
            console.log('Opening diver details modal for diver:', diverId);
            currentDiverId = diverId;
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === diverId);
            document.getElementById('bottleSizeInput').value = diver.bottleSize || '';
            document.getElementById('pressureInput').value = diver.pressure || '';
            document.getElementById('plannedDepthInput').value = diver.plannedDepth || '';
            document.getElementById('plannedTimeInput').value = diver.plannedTime || '';
            document.getElementById('gasAir').checked = diver.gas === 'Ilma' || !diver.gas;
            document.getElementById('gasMixed').checked = diver.gas && diver.gas !== 'Ilma';
            document.getElementById('mixedGasInput').value = diver.gas && diver.gas !== 'Ilma' ? diver.gas : '';
            document.getElementById('mixedGasInput').style.display = document.getElementById('gasMixed').checked ? 'block' : 'none';
            const modal = new bootstrap.Modal(document.getElementById('diverDetailsModal'));
            modal.show();
        }

        // Toggle mixed gas input visibility
        document.addEventListener('change', function(e) {
            if (e.target.name === 'gasType') {
                document.getElementById('mixedGasInput').style.display = e.target.value === 'Seoskaasu' ? 'block' : 'none';
            }
        });

        // Save diver details
        function saveDiverDetails() {
            console.log('Saving diver details for diver:', currentDiverId);
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === currentDiverId);
            diver.bottleSize = document.getElementById('bottleSizeInput').value;
            diver.pressure = document.getElementById('pressureInput').value;
            diver.plannedDepth = document.getElementById('plannedDepthInput').value;
            diver.plannedTime = document.getElementById('plannedTimeInput').value;
            diver.timeLeft = parseInt(diver.plannedTime) || 0;
            const gasType = document.querySelector('input[name="gasType"]:checked').value;
            diver.gas = gasType === 'Ilma' ? 'Ilma' : document.getElementById('mixedGasInput').value || 'Seoskaasu';
            localStorage.setItem('diveEvents', JSON.stringify(events));
            const modal = bootstrap.Modal.getInstance(document.getElementById('diverDetailsModal'));
            modal.hide();
            loadEventDetails();
        }

        // Open buddy modal
        function openBuddyModal(diverId) {
            console.log('Opening buddy modal for diver:', diverId);
            currentDiverId = diverId;
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === diverId);
            const buddyCheckboxes = document.getElementById('buddyCheckboxes');
            buddyCheckboxes.innerHTML = event.divers.map(d => d.id !== diverId ? `
                <div class="form-check">
                    <input type="checkbox" class="form-check-input buddy-checkbox" data-buddy-id="${d.id}" ${diver.buddies.includes(d.id) ? 'checked' : ''}>
                    <label class="form-check-label">${d.name}</label>
                </div>
            ` : '').join('');
            const modal = new bootstrap.Modal(document.getElementById('buddyModal'));
            modal.show();
        }

        // Save buddies
        function saveBuddies() {
            console.log('Saving buddies for diver:', currentDiverId);
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === currentDiverId);
            const checkboxes = document.querySelectorAll('#buddyCheckboxes .buddy-checkbox');
            diver.buddies = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.dataset.buddyId);
            localStorage.setItem('diveEvents', JSON.stringify(events));
            const modal = bootstrap.Modal.getInstance(document.getElementById('buddyModal'));
            modal.hide();
            loadEventDetails();
        }

        // Open notes modal
        function openNotesModal(diverId) {
            console.log('Opening notes modal for diver:', diverId);
            currentDiverId = diverId;
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === diverId);
            document.getElementById('notesInput').value = diver.notes || '';
            const modal = new bootstrap.Modal(document.getElementById('notesModal'));
            modal.show();
        }

        // Save notes
        function saveNotes() {
            console.log('Saving notes for diver:', currentDiverId);
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === currentDiverId);
            diver.notes = document.getElementById('notesInput').value;
            localStorage.setItem('diveEvents', JSON.stringify(events));
            const modal = bootstrap.Modal.getInstance(document.getElementById('notesModal'));
            modal.hide();
            loadEventDetails();
        }

        // Open final pressure modal
        function openFinalPressureModal(diverId) {
            console.log('Opening final pressure modal for diver:', diverId);
            currentDiverId = diverId;
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === diverId);
            document.getElementById('finalPressureInput').value = diver.finalPressure || '';
            const modal = new bootstrap.Modal(document.getElementById('finalPressureModal'));
            modal.show();
        }

        // Save final pressure
        function saveFinalPressure() {
            console.log('Saving final pressure for diver:', currentDiverId);
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === currentDiverId);
            const finalPressure = document.getElementById('finalPressureInput').value;
            diver.finalPressure = finalPressure;
            if (diver.pressure && finalPressure) {
                const usedPressure = parseFloat(diver.pressure) - parseFloat(finalPressure);
                diver.airConsumption = usedPressure * parseFloat(diver.bottleSize);
            } else {
                diver.airConsumption = '';
            }
            localStorage.setItem('diveEvents', JSON.stringify(events));
            const modal = bootstrap.Modal.getInstance(document.getElementById('finalPressureModal'));
            modal.hide();
            loadEventDetails();
        }

        // Load event details
        function loadEventDetails() {
            console.log('Loading event details for event ID:', currentEventId);
            const event = events.find(e => e.id === currentEventId);
            if (!event) {
                console.error('Event not found:', currentEventId);
                return;
            }
            document.getElementById('eventTitle').textContent = event.location;
            document.getElementById('eventDiveMaster').textContent = event.diveMaster;
            document.getElementById('eventDate').textContent = event.date;
            const diverList = document.getElementById('diverList');
            diverList.innerHTML = '';

            // Add header row
            const headerDiv = document.createElement('div');
            headerDiv.className = 'row align-items-center font-weight-bold mb-2';
            headerDiv.innerHTML = `
                <div class="col-md-2">Nimi</div>
                <div class="col-md-1">Pullon koko</div>
                <div class="col-md-1">Paine</div>
                <div class="col-md-1">Kaasu</div>
                <div class="col-md-1">Suunniteltu aika</div>
                <div class="col-md-1">Suunniteltu syvyys</div>
                <div class="col-md-1">Pari</div>
                <div class="col-md-2">Muistiinpanot</div>
                <div class="col-md-1">Sukellusaika</div>
                <div class="col-md-1">Jäljellä oleva aika</div>
                <div class="col-md-1">Lopullinen paine</div>
                <div class="col-md-1">Toiminnot</div>
            `;
            diverList.appendChild(headerDiv);

            // List divers in order of addition
            event.divers.forEach(diver => {
                const buddyNames = diver.buddies.map(buddyId => event.divers.find(d => d.id === buddyId)?.name || '').filter(name => name).join(', ') || 'Ei paria';
                const div = document.createElement('div');
                div.className = 'diver-row';
                div.innerHTML = `
                    <div class="row align-items-center">
                        <div class="col-md-2">${diver.name}</div>
                        <div class="col-md-1">
                            ${!diver.diveStarted ? `<span class="input-span" onclick="openDiverDetailsModal('${diver.id}')">${diver.bottleSize ? `${diver.bottleSize} L` : 'Syötä tiedot'}</span>` : `<span>${diver.bottleSize ? `${diver.bottleSize} L` : ''}</span>`}
                        </div>
                        <div class="col-md-1">
                            ${!diver.diveStarted ? `<span class="input-span" onclick="openDiverDetailsModal('${diver.id}')">${diver.pressure ? `${diver.pressure} bar` : ''}</span>` : `<span>${diver.pressure ? `${diver.pressure} bar` : ''}</span>`}
                        </div>
                        <div class="col-md-1">
                            ${!diver.diveStarted ? `<span class="input-span" onclick="openDiverDetailsModal('${diver.id}')">${diver.gas ? diver.gas : 'Syötä tiedot'}</span>` : `<span>${diver.gas || ''}</span>`}
                        </div>
                        <div class="col-md-1">
                            ${!diver.diveStarted ? `<span class="input-span" onclick="openDiverDetailsModal('${diver.id}')">${diver.plannedTime ? `${diver.plannedTime} min` : 'Syötä tiedot'}</span>` : `<span>${diver.plannedTime ? `${diver.plannedTime} min` : ''}</span>`}
                        </div>
                        <div class="col-md-1">
                            ${!diver.diveStarted ? `<span class="input-span" onclick="openDiverDetailsModal('${diver.id}')">${diver.plannedDepth ? `${diver.plannedDepth} m` : 'Syötä tiedot'}</span>` : `<span>${diver.plannedDepth ? `${diver.plannedDepth} m` : ''}</span>`}
                        </div>
                        <div class="col-md-1">
                            ${!diver.diveStarted ? `<span class="input-span" onclick="openBuddyModal('${diver.id}')">${buddyNames}</span>` : `<span>${buddyNames}</span>`}
                        </div>
                        <div class="col-md-2">
                            <span class="input-span" onclick="openNotesModal('${diver.id}')">${diver.notes || 'Ei muistiinpanoja'}</span>
                        </div>
                        <div class="col-md-1">
                            ${diver.diveStarted || diver.diveEnded ? `
                                <span class="dive-time ${diver.timeLeft <= 5 && !diver.diveEnded ? 'dive-time-warning' : ''} ${diver.timeLeft <= 0 && !diver.diveEnded ? 'dive-time-over' : ''}" id="diveTime_${diver.id}">${formatTime(diver.diveTime)}</span>
                                ${diver.airConsumption ? `<span>, Kaasun kulutus: ${diver.airConsumption} L</span>` : ''}
                            ` : ''}
                        </div>
                        <div class="col-md-1">
                            ${diver.diveStarted && !diver.diveEnded ? `<span>(${formatTime(diver.timeLeft * 60)})</span>` : ''}
                        </div>
                        <div class="col-md-1">
                            ${diver.diveEnded ? `<span class="input-span" onclick="openFinalPressureModal('${diver.id}')">${diver.finalPressure ? `${diver.finalPressure} bar` : 'Syötä paine'}</span>` : ''}
                        </div>
                        <div class="col-md-1">
                            ${diver.diveStarted && !diver.diveEnded ? `
                                ${diver.paused ? `
                                    <span class="resume-icon" onclick="resumeDive('${diver.id}')">▶️</span>
                                    <span class="stop-icon" onclick="stopDive('${diver.id}')">⏹️</span>
                                ` : `
                                    <span class="pause-icon" onclick="pauseDive('${diver.id}')">⏸️</span>
                                    <span class="stop-icon" onclick="stopDive('${diver.id}')">⏹️</span>
                                `}
                            ` : diver.diveEnded ? `
                                <span>Pinnalla</span>
                            ` : `
                                ${isDiverReady(diver) ? `<span class="play-icon" onclick="startDive('${diver.id}')">▶️</span>` : ''}
                                <span class="trash-icon" onclick="confirmDeleteDiver('${diver.id}')">🗑️</span>
                            `}
                        </div>
                    </div>`;
                diverList.appendChild(div);
            });

            // Show/hide end event and PDF buttons
            document.getElementById('endEventBtn').style.display = event.divers.every(d => d.diveEnded) && !event.ended ? 'inline-block' : 'none';
            document.getElementById('generatePdfBtn').style.display = event.ended ? 'inline-block' : 'none';
        }

        // Check if diver is ready to start (only plannedTime, plannedDepth, and gas are required)
        function isDiverReady(diver) {
            return diver.plannedTime && diver.plannedDepth && diver.gas;
        }

        // Add diver
        document.getElementById('diverForm').addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Adding new diver');
            const event = events.find(e => e.id === currentEventId);
            const diver = {
                id: Date.now().toString(),
                name: document.getElementById('diverName').value,
                bottleSize: '',
                pressure: '',
                gas: '',
                plannedTime: '',
                plannedDepth: '',
                buddies: [],
                notes: '',
                diveStarted: false,
                diveEnded: false,
                diveTime: 0,
                timeLeft: 0,
                paused: false,
                finalPressure: '',
                airConsumption: ''
            };
            event.divers.push(diver);
            localStorage.setItem('diveEvents', JSON.stringify(events));
            showEventView();
        });

        // Start dive
        function startDive(diverId) {
            console.log('Starting dive for diver:', diverId);
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === diverId);
            diver.diveStarted = true;
            diver.diveTime = 0;
            diver.timeLeft = parseInt(diver.plannedTime);
            timers[diverId] = setInterval(() => {
                if (!diver.paused) {
                    diver.diveTime++;
                    diver.timeLeft = parseInt(diver.plannedTime) - Math.floor(diver.diveTime / 60);
                    localStorage.setItem('diveEvents', JSON.stringify(events));
                    loadEventDetails();
                }
            }, 1000);
            localStorage.setItem('diveEvents', JSON.stringify(events));
            loadEventDetails();
        }

        // Pause dive
        function pauseDive(diverId) {
            console.log('Pausing dive for diver:', diverId);
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === diverId);
            diver.paused = true;
            localStorage.setItem('diveEvents', JSON.stringify(events));
            loadEventDetails();
        }

        // Resume dive
        function resumeDive(diverId) {
            console.log('Resuming dive for diver:', diverId);
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === diverId);
            diver.paused = false;
            localStorage.setItem('diveEvents', JSON.stringify(events));
            loadEventDetails();
        }

        // Stop dive with confirmation including diver's name
        function stopDive(diverId) {
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === diverId);
            if (confirm(`Haluatko varmasti päättää sukelluksen sukeltajalle ${diver.name}?`)) {
                console.log('Stopping dive for diver:', diverId);
                clearInterval(timers[diverId]);
                delete timers[diverId];
                diver.diveEnded = true;
                diver.paused = false;
                localStorage.setItem('diveEvents', JSON.stringify(events));
                loadEventDetails();
            }
        }

        // End event
        function endEvent() {
            console.log('Ending event:', currentEventId);
            const event = events.find(e => e.id === currentEventId);
            event.ended = true;
            localStorage.setItem('diveEvents', JSON.stringify(events));
            loadEventDetails();
        }

        // Format time (seconds to min:sec)
        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = seconds % 60;
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }

        // Generate PDF in portrait mode
        function generatePdf() {
            console.log('Generating PDF for event:', currentEventId);
            try {
                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    throw new Error('jsPDF library not loaded');
                }
                const doc = new jsPDF({ orientation: 'portrait' });
                const pageWidth = doc.internal.pageSize.getWidth();
                const maxLineWidth = pageWidth - 30; // 15mm margin for indented lines

                const event = events.find(e => e.id === currentEventId);
                if (!event) {
                    throw new Error('Event not found for ID: ' + currentEventId);
                }

                // Header
                doc.setFontSize(16);
                doc.text(`Sukelluspöytäkirja: ${event.location}`, 10, 10);
                doc.setFontSize(12);
                doc.text(`Sukellusvanhin: ${event.diveMaster}`, 10, 20);
                doc.text(`Päivämäärä: ${event.date}`, 10, 30);
                doc.text('Sukeltajat:', 10, 40);

                // Diver details
                let y = 50;
                event.divers.forEach(diver => {
                    const buddyNames = diver.buddies.map(buddyId => event.divers.find(d => d.id === buddyId)?.name || '').filter(name => name).join(', ') || 'Ei paria';
                    // Diver name
                    doc.text(`${diver.name || 'Nimetön'}`, 10, y);
                    y += 7;
                    // Planned details (indented)
                    const plannedText = `Pullon koko: ${diver.bottleSize || '-'} L, Paine ennen: ${diver.pressure || '-'} bar, Kaasu: ${diver.gas || '-'}, Suunniteltu syvyys: ${diver.plannedDepth || '-'} m, Suunniteltu aika: ${diver.plannedTime || '-'} min`;
                    const plannedLines = doc.splitTextToSize(plannedText, maxLineWidth);
                    doc.text(plannedLines, 15, y); // Indented by 15mm
                    y += plannedLines.length * 7;
                    // Actual details (indented)
                    const actualText = `Toteutunut aika: ${formatTime(diver.diveTime || 0)}, Lopullinen paine: ${diver.finalPressure || '-'} bar, Käytetty kaasu: ${diver.airConsumption || '-'} L, Muistiinpanot: ${diver.notes || 'Ei muistiinpanoja'}`;
                    const actualLines = doc.splitTextToSize(actualText, maxLineWidth);
                    doc.text(actualLines, 15, y); // Indented by 15mm
                    y += actualLines.length * 7;
                    if (y > 270) { // Add new page if near bottom (A4 height is 297mm)
                        doc.addPage();
                        y = 10;
                    }
                });

                doc.save(`${event.location}_Sukelluspöytäkirja.pdf`);
                console.log('PDF generated successfully');
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Virhe PDF:n luomisessa: ' + error.message);
            }
        }

        // Initialize
        loadTheme();
        showMainView();
    </script>
</body>
</html>
