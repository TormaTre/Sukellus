<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sukelluspöytäkirja</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .dive-time { color: green; font-size: 1.4em; }
        .dive-time-warning { color: orange; font-size: 1.4em; }
        .dive-time-over { color: red; font-size: 1.4em; }
        .diver-row { margin-bottom: 10px; }
        .trash-icon, .play-icon, .pause-icon, .resume-icon, .stop-icon {
            cursor: pointer;
            margin-left: 10px;
            font-size: 2em; /* Reverted to 2em for action buttons */
        }
        .event-header { margin-bottom: 20px; }
        .font-weight-bold { font-weight: bold; }
        .mb-2 { margin-bottom: 0.5rem; }
        .buddy-checkboxes { max-height: 100px; overflow-y: auto; }
        .notes-span { cursor: pointer; text-decoration: underline; }
        .final-pressure-span { cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>
    <!-- Main View -->
    <div id="mainView" class="container">
        <h1>Sukelluspöytäkirja</h1>
        <button class="btn btn-primary mb-3" onclick="showNewEventForm()">Uusi Tapahtuma</button>
        <button class="btn btn-info mb-3" onclick="backupEvents()">Varmuuskopioi</button>
        <label class="btn btn-secondary mb-3">
            Palauta <input type="file" id="restoreInput" accept=".json" onchange="restoreEvents(event)" style="display: none;">
        </label>
        <h3>Aiemmat Tapahtumat</h3>
        <ul id="eventList" class="list-group"></ul>
    </div>

    <!-- New Event Form -->
    <div id="newEventForm" class="container" style="display: none;">
        <h2>Luo Uusi Tapahtuma</h2>
        <form id="eventForm">
            <div class="mb-3">
                <label for="location" class="form-label">Sijainti</label>
                <input type="text" class="form-control" id="location" required>
            </div>
            <div class="mb-3">
                <label for="diveMaster" class="form-label">Sukellusvanhin</label>
                <input type="text" class="form-control" id="diveMaster" required>
            </div>
            <button type="submit" class="btn btn-primary">Luo Tapahtuma</button>
            <button type="button" class="btn btn-secondary" onclick="showMainView()">Peruuta</button>
        </form>
    </div>

    <!-- Event View -->
    <div id="eventView" class="container" style="display: none;">
        <h2 id="eventTitle" class="event-header"></h2>
        <p><strong>Sukellusvanhin:</strong> <span id="eventDiveMaster"></span></p>
        <p><strong>Päivämäärä:</strong> <span id="eventDate"></span></p>
        <button class="btn btn-primary mb-3" onclick="showAddDiverForm()">Lisää Sukeltaja</button>
        <div id="diverList"></div>
        <button id="endEventBtn" class="btn btn-success mt-3" style="display: none;" onclick="endEvent()">Lopeta Tapahtuma</button>
        <button id="generatePdfBtn" class="btn btn-info mt-3" style="display: none;" onclick="generatePdf()">Luo PDF</button>
        <button class="btn btn-secondary mt-3" onclick="showMainView()">Takaisin Päänäkymään</button>
    </div>

    <!-- Add Diver Form -->
    <div id="addDiverForm" class="container" style="display: none;">
        <h2>Lisää Sukeltaja</h2>
        <form id="diverForm">
            <div class="mb-3">
                <label for="diverName" class="form-label">Sukeltajan Nimi</label>
                <input type="text" class="form-control" id="diverName" required>
            </div>
            <button type="submit" class="btn btn-primary">Lisää Sukeltaja</button>
            <button type="button" class="btn btn-secondary" onclick="showEventView()">Peruuta</button>
        </form>
    </div>

    <!-- Notes Modal -->
    <div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notesModalLabel">Muokkaa Muistiinpanoja</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sulje"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control" id="notesInput" placeholder="Muistiinpanot">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Peruuta</button>
                    <button type="button" class="btn btn-primary" onclick="saveNotes()">Tallenna</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Final Pressure Modal -->
    <div class="modal fade" id="finalPressureModal" tabindex="-1" aria-labelledby="finalPressureModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="finalPressureModalLabel">Syötä Lopullinen Paine</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sulje"></button>
                </div>
                <div class="modal-body">
                    <input type="number" class="form-control" id="finalPressureInput" placeholder="Lopullinen paine (bar)">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Peruuta</button>
                    <button type="button" class="btn btn-primary" onclick="saveFinalPressure()">Tallenna</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        let events = JSON.parse(localStorage.getItem('diveEvents')) || [];
        let currentEventId = null;
        let timers = {};
        let currentDiverId = null;

        // Backup events to a JSON file
        function backupEvents() {
            console.log('Backing up events');
            const data = JSON.stringify(events, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sukelluspöytäkirja_backup.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log('Backup completed');
        }

        // Restore events from a JSON file
        function restoreEvents(event) {
            console.log('Restoring events');
            const file = event.target.files[0];
            if (!file) {
                console.error('No file selected');
                alert('Valitse JSON-tiedosto palauttaaksesi tapahtumat.');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const restoredEvents = JSON.parse(e.target.result);
                    if (!Array.isArray(restoredEvents)) {
                        throw new Error('Invalid JSON format: Not an array');
                    }
                    for (const evt of restoredEvents) {
                        if (!evt.id || !evt.location || !evt.diveMaster || !evt.date || !Array.isArray(evt.divers)) {
                            throw new Error('Invalid event structure');
                        }
                    }
                    events = restoredEvents;
                    localStorage.setItem('diveEvents', JSON.stringify(events));
                    loadEvents();
                    console.log('Events restored successfully');
                    alert('Tapahtumat palautettu onnistuneesti.');
                } catch (error) {
                    console.error('Error restoring events:', error);
                    alert('Virhe palautettaessa tapahtumia: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Show main view
        function showMainView() {
            console.log('Showing main view');
            document.getElementById('mainView').style.display = 'block';
            document.getElementById('newEventForm').style.display = 'none';
            document.getElementById('eventView').style.display = 'none';
            document.getElementById('addDiverForm').style.display = 'none';
            loadEvents();
        }

        // Show new event form
        function showNewEventForm() {
            console.log('Showing new event form');
            try {
                document.getElementById('mainView').style.display = 'none';
                document.getElementById('newEventForm').style.display = 'block';
                document.getElementById('eventView').style.display = 'none';
                document.getElementById('addDiverForm').style.display = 'none';
            } catch (error) {
                console.error('Error in showNewEventForm:', error);
            }
        }

        // Show event view
        function showEventView() {
            console.log('Showing event view for event ID:', currentEventId);
            document.getElementById('mainView').style.display = 'none';
            document.getElementById('newEventForm').style.display = 'none';
            document.getElementById('eventView').style.display = 'block';
            document.getElementById('addDiverForm').style.display = 'none';
            loadEventDetails();
        }

        // Show add diver form
        function showAddDiverForm() {
            console.log('Showing add diver form');
            document.getElementById('eventView').style.display = 'none';
            document.getElementById('addDiverForm').style.display = 'block';
        }

        // Load events in main view
        function loadEvents() {
            console.log('Loading events:', events);
            const eventList = document.getElementById('eventList');
            eventList.innerHTML = '';
            events.forEach(event => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `${event.location} - ${event.date} - ${event.diveMaster}
                    <span>
                        <button class="btn btn-sm btn-primary" onclick="openEvent('${event.id}')">Avaa</button>
                        <span class="trash-icon" onclick="confirmDeleteEvent('${event.id}')">🗑️</span>
                    </span>`;
                eventList.appendChild(li);
            });
        }

        // Confirm event deletion
        function confirmDeleteEvent(eventId) {
            if (confirm('Haluatko varmasti poistaa tämän tapahtuman?')) {
                events = events.filter(event => event.id !== eventId);
                localStorage.setItem('diveEvents', JSON.stringify(events));
                loadEvents();
            }
        }

        // Create new event
        document.getElementById('eventForm').addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Creating new event');
            const location = document.getElementById('location').value;
            const diveMaster = document.getElementById('diveMaster').value;
            const event = {
                id: Date.now().toString(),
                location,
                diveMaster,
                date: new Date().toLocaleDateString('fi-FI'),
                divers: [],
                ended: false
            };
            events.push(event);
            localStorage.setItem('diveEvents', JSON.stringify(events));
            currentEventId = event.id;
            showEventView();
        });

        // Open an event
        function openEvent(eventId) {
            console.log('Opening event:', eventId);
            currentEventId = eventId;
            showEventView();
        }

        // Confirm diver deletion
        function confirmDeleteDiver(diverId) {
            if (confirm('Haluatko varmasti poistaa tämän sukeltajan?')) {
                console.log('Deleting diver:', diverId);
                const event = events.find(e => e.id === currentEventId);
                event.divers = event.divers.filter(diver => {
                    if (diver.id === diverId) {
                        if (timers[diverId]) {
                            clearInterval(timers[diverId]);
                            delete timers[diverId];
                        }
                        return false;
                    }
                    if (diver.buddies.includes(diverId)) {
                        diver.buddies = diver.buddies.filter(id => id !== diverId);
                    }
                    return true;
                });
                localStorage.setItem('diveEvents', JSON.stringify(events));
                loadEventDetails();
            }
        }

        // Open notes modal
        function openNotesModal(diverId) {
            console.log('Opening notes modal for diver:', diverId);
            currentDiverId = diverId;
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === diverId);
            document.getElementById('notesInput').value = diver.notes || '';
            const modal = new bootstrap.Modal(document.getElementById('notesModal'));
            modal.show();
        }

        // Save notes from modal
        function saveNotes() {
            console.log('Saving notes for diver:', currentDiverId);
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === currentDiverId);
            diver.notes = document.getElementById('notesInput').value;
            localStorage.setItem('diveEvents', JSON.stringify(events));
            const modal = bootstrap.Modal.getInstance(document.getElementById('notesModal'));
            modal.hide();
            loadEventDetails();
        }

        // Open final pressure modal
        function openFinalPressureModal(diverId) {
            console.log('Opening final pressure modal for diver:', diverId);
            currentDiverId = diverId;
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === diverId);
            document.getElementById('finalPressureInput').value = diver.finalPressure || '';
            const modal = new bootstrap.Modal(document.getElementById('finalPressureModal'));
            modal.show();
        }

        // Save final pressure from modal
        function saveFinalPressure() {
            console.log('Saving final pressure for diver:', currentDiverId);
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === currentDiverId);
            diver.finalPressure = document.getElementById('finalPressureInput').value;
            if (diver.pressure && diver.finalPressure) {
                const usedPressure = parseFloat(diver.pressure) - parseFloat(diver.finalPressure);
                diver.airConsumption = usedPressure * parseFloat(diver.bottleSize);
            } else {
                diver.airConsumption = '';
            }
            localStorage.setItem('diveEvents', JSON.stringify(events));
            const modal = bootstrap.Modal.getInstance(document.getElementById('finalPressureModal'));
            modal.hide();
            loadEventDetails();
        }

        // Load event details
        function loadEventDetails() {
            console.log('Loading event details for event ID:', currentEventId);
            const event = events.find(e => e.id === currentEventId);
            if (!event) {
                console.error('Event not found:', currentEventId);
                return;
            }
            document.getElementById('eventTitle').textContent = event.location;
            document.getElementById('eventDiveMaster').textContent = event.diveMaster;
            document.getElementById('eventDate').textContent = event.date;
            const diverList = document.getElementById('diverList');
            diverList.innerHTML = '';

            // Add header row
            const headerDiv = document.createElement('div');
            headerDiv.className = 'row align-items-center font-weight-bold mb-2';
            headerDiv.innerHTML = `
                <div class="col-md-2">Nimi</div>
                <div class="col-md-1">Pullon koko</div>
                <div class="col-md-1">Paine</div>
                <div class="col-md-1">Suunniteltu aika</div>
                <div class="col-md-1">Suunniteltu syvyys</div>
                <div class="col-md-1">Pari</div>
                <div class="col-md-2">Muistiinpanot</div>
                <div class="col-md-2">Sukellusaika</div>
                <div class="col-md-1">Jäljellä oleva aika</div>
                <div class="col-md-1">Lopullinen paine</div>
                <div class="col-md-1">Toiminnot</div>
            `;
            diverList.appendChild(headerDiv);

            // Group divers by buddy pairs (optional, kept for visual grouping)
            const groupedDivers = {};
            event.divers.forEach(diver => {
                const buddyId = diver.buddies.length > 0 ? diver.buddies[0] : diver.id;
                if (!groupedDivers[buddyId]) {
                    groupedDivers[buddyId] = [];
                }
                groupedDivers[buddyId].push(diver);
            });

            Object.values(groupedDivers).forEach(group => {
                group.forEach(diver => {
                    const div = document.createElement('div');
                    div.className = 'diver-row';
                    div.innerHTML = `
                        <div class="row align-items-center">
                            <div class="col-md-2">${diver.name}</div>
                            <div class="col-md-1">
                                <input type="number" class="form-control bottle-size" data-id="${diver.id}" value="${diver.bottleSize || ''}" placeholder="Pullon koko (L)" ${diver.diveStarted ? 'disabled' : ''} required>
                            </div>
                            <div class="col-md-1">
                                <input type="number" class="form-control pressure" data-id="${diver.id}" value="${diver.pressure || ''}" placeholder="Paine (bar)" ${diver.diveStarted ? 'disabled' : ''}>
                            </div>
                            <div class="col-md-1">
                                <input type="number" class="form-control planned-time" data-id="${diver.id}" value="${diver.plannedTime || ''}" placeholder="Aika (min)" ${diver.diveStarted ? 'disabled' : ''} required>
                            </div>
                            <div class="col-md-1">
                                <input type="number" class="form-control planned-depth" data-id="${diver.id}" value="${diver.plannedDepth || ''}" placeholder="Syvyys (m)" ${diver.diveStarted ? 'disabled' : ''} required>
                            </div>
                            <div class="col-md-1">
                                ${diver.diveStarted ? `
                                    <span>${diver.buddies.map(buddyId => event.divers.find(d => d.id === buddyId)?.name || '').filter(name => name).join(', ') || 'Ei paria'}</span>
                                ` : `
                                    <div class="buddy-checkboxes">
                                        ${event.divers.map(d => d.id !== diver.id ? `
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input buddy-checkbox" data-id="${diver.id}" data-buddy-id="${d.id}" ${diver.buddies.includes(d.id) ? 'checked' : ''}>
                                                <label class="form-check-label">${d.name}</label>
                                            </div>
                                        ` : '').join('')}
                                    </div>
                                `}
                            </div>
                            <div class="col-md-2">
                                ${diver.diveStarted && !diver.diveEnded ? `
                                    <span class="notes-span" onclick="openNotesModal('${diver.id}')">${diver.notes || 'Ei muistiinpanoja'}</span>
                                ` : `
                                    <input type="text" class="form-control notes" data-id="${diver.id}" value="${diver.notes || ''}" placeholder="Muistiinpanot">
                                `}
                            </div>
                            <div class="col-md-2">
                                ${diver.diveStarted || diver.diveEnded ? `
                                    <span class="dive-time ${diver.timeLeft <= 5 && !diver.diveEnded ? 'dive-time-warning' : ''} ${diver.timeLeft <= 0 && !diver.diveEnded ? 'dive-time-over' : ''}" id="diveTime_${diver.id}">${formatTime(diver.diveTime)}</span>
                                    ${diver.airConsumption ? `<span>, Kaasun kulutus: ${diver.airConsumption} L</span>` : ''}
                                ` : ''}
                            </div>
                            <div class="col-md-1">
                                ${diver.diveStarted && !diver.diveEnded ? `
                                    <span>(${formatTime(diver.timeLeft * 60)})</span>
                                ` : ''}
                            </div>
                            <div class="col-md-1">
                                ${diver.diveEnded ? `
                                    <span class="final-pressure-span" onclick="openFinalPressureModal('${diver.id}')">${diver.finalPressure ? `${diver.finalPressure} bar` : 'Syötä paine'}</span>
                                ` : ''}
                            </div>
                            <div class="col-md-1">
                                ${diver.diveStarted && !diver.diveEnded ? `
                                    ${diver.paused ? `
                                        <span class="resume-icon" onclick="resumeDive('${diver.id}')">▶️</span>
                                        <span class="stop-icon" onclick="stopDive('${diver.id}')">⏹️</span>
                                    ` : `
                                        <span class="pause-icon" onclick="pauseDive('${diver.id}')">⏸️</span>
                                        <span class="stop-icon" onclick="stopDive('${diver.id}')">⏹️</span>
                                    `}
                                ` : diver.diveEnded ? `
                                    <span>Pinnalla</span>
                                ` : `
                                    ${isDiverReady(diver) ? `<span class="play-icon" onclick="startDive('${diver.id}')">▶️</span>` : ''}
                                    <span class="trash-icon" onclick="confirmDeleteDiver('${diver.id}')">🗑️</span>
                                `}
                            </div>
                        </div>`;
                    diverList.appendChild(div);
                });
            });

            // Show/hide end event and PDF buttons
            document.getElementById('endEventBtn').style.display = event.divers.every(d => d.diveEnded) && !event.ended ? 'inline-block' : 'none';
            document.getElementById('generatePdfBtn').style.display = event.ended ? 'inline-block' : 'none';
        }

        // Check if diver is ready to start (required fields filled)
        function isDiverReady(diver) {
            return diver.bottleSize && diver.plannedTime && diver.plannedDepth;
        }

        // Add diver
        document.getElementById('diverForm').addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Adding new diver');
            const event = events.find(e => e.id === currentEventId);
            const diver = {
                id: Date.now().toString(),
                name: document.getElementById('diverName').value,
                bottleSize: '',
                pressure: '',
                plannedTime: '',
                plannedDepth: '',
                buddies: [],
                notes: '',
                diveStarted: false,
                diveEnded: false,
                diveTime: 0,
                timeLeft: 0,
                paused: false,
                finalPressure: '',
                airConsumption: ''
            };
            event.divers.push(diver);
            localStorage.setItem('diveEvents', JSON.stringify(events));
            showEventView();
        });

        // Update diver details
        document.addEventListener('change', function(e) {
            const event = events.find(e => e.id === currentEventId);
            const diverId = e.target.dataset.id;
            const diver = event.divers.find(d => d.id === diverId);
            if (!diver) return;

            if (e.target.classList.contains('bottle-size')) {
                diver.bottleSize = e.target.value;
            } else if (e.target.classList.contains('pressure')) {
                diver.pressure = e.target.value;
            } else if (e.target.classList.contains('planned-time')) {
                diver.plannedTime = e.target.value;
                diver.timeLeft = parseInt(e.target.value);
            } else if (e.target.classList.contains('planned-depth')) {
                diver.plannedDepth = e.target.value;
            } else if (e.target.classList.contains('buddy-checkbox')) {
                const buddyId = e.target.dataset.buddyId;
                if (e.target.checked) {
                    if (!diver.buddies.includes(buddyId)) {
                        diver.buddies.push(buddyId);
                    }
                } else {
                    diver.buddies = diver.buddies.filter(id => id !== buddyId);
                }
            } else if (e.target.classList.contains('notes')) {
                diver.notes = e.target.value;
            }
            localStorage.setItem('diveEvents', JSON.stringify(events));
            loadEventDetails();
        });

        // Start dive
        function startDive(diverId) {
            console.log('Starting dive for diver:', diverId);
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === diverId);
            diver.diveStarted = true;
            diver.diveTime = 0;
            diver.timeLeft = parseInt(diver.plannedTime);
            timers[diverId] = setInterval(() => {
                if (!diver.paused) {
                    diver.diveTime++;
                    diver.timeLeft = parseInt(diver.plannedTime) - Math.floor(diver.diveTime / 60);
                    localStorage.setItem('diveEvents', JSON.stringify(events));
                    loadEventDetails();
                }
            }, 1000);
            localStorage.setItem('diveEvents', JSON.stringify(events));
            loadEventDetails();
        }

        // Pause dive
        function pauseDive(diverId) {
            console.log('Pausing dive for diver:', diverId);
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === diverId);
            diver.paused = true;
            localStorage.setItem('diveEvents', JSON.stringify(events));
            loadEventDetails();
        }

        // Resume dive
        function resumeDive(diverId) {
            console.log('Resuming dive for diver:', diverId);
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === diverId);
            diver.paused = false;
            localStorage.setItem('diveEvents', JSON.stringify(events));
            loadEventDetails();
        }

        // Stop dive with confirmation
        function stopDive(diverId) {
            if (confirm('Haluatko varmasti päättää sukelluksen?')) {
                console.log('Stopping dive for diver:', diverId);
                const event = events.find(e => e.id === currentEventId);
                const diver = event.divers.find(d => d.id === diverId);
                clearInterval(timers[diverId]);
                delete timers[diverId];
                diver.diveEnded = true;
                diver.paused = false;
                localStorage.setItem('diveEvents', JSON.stringify(events));
                loadEventDetails();
                // Open final pressure modal immediately after stopping dive
                openFinalPressureModal(diverId);
            }
        }

        // End event
        function endEvent() {
            console.log('Ending event:', currentEventId);
            const event = events.find(e => e.id === currentEventId);
            event.ended = true;
            localStorage.setItem('diveEvents', JSON.stringify(events));
            loadEventDetails();
        }

        // Format time (seconds to min:sec)
        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = seconds % 60;
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }

        // Generate PDF in portrait mode
        function generatePdf() {
            console.log('Generating PDF for event:', currentEventId);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait' });
            const event = events.find(e => e.id === currentEventId);
            const pageWidth = doc.internal.pageSize.getWidth();
            const maxLineWidth = pageWidth - 20; // 10mm margin on each side

            // Header
            doc.setFontSize(16);
            doc.text(`Sukelluspöytäkirja: ${event.location}`, 10, 10);
            doc.setFontSize(12);
            doc.text(`Sukellusvanhin: ${event.diveMaster}`, 10, 20);
            doc.text(`Päivämäärä: ${event.date}`, 10, 30);
            doc.text('Sukeltajat:', 10, 40);

            // Diver details
            let y = 50;
            event.divers.forEach(diver => {
                const buddyNames = diver.buddies.map(buddyId => event.divers.find(d => d.id === buddyId)?.name || '').filter(name => name).join(', ') || 'Ei paria';
                const diverText = `- ${diver.name}: Sukellusaika: ${formatTime(diver.diveTime)}${diver.airConsumption ? `, Kaasun kulutus: ${diver.airConsumption} L` : ''}, Syvyys: ${diver.plannedDepth} m, Parit: ${buddyNames}, Muistiinpanot: ${diver.notes || 'Ei muistiinpanoja'}`;
                const lines = doc.splitTextToSize(diverText, maxLineWidth);
                doc.text(lines, 10, y);
                y += lines.length * 7; // Adjust line height (7mm per line)
                if (y > 270) { // Add new page if near bottom (A4 height is 297mm)
                    doc.addPage();
                    y = 10;
                }
            });

            doc.save(`${event.location}_Sukelluspöytäkirja.pdf`);
        }

        // Initialize
        showMainView();
    </script>
</body>
</html>
