<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sukelluspöytäkirja</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Light mode (default) */
        body[data-theme="light"] {
            background-color: #ffffff;
            color: #000000;
        }

        /* Dark mode */
        body[data-theme="dark"] {
            background-color: #343a40;
            color: #ffffff;
        }
        body[data-theme="dark"] .container,
        body[data-theme="dark"] .modal-content,
        body[data-theme="dark"] .list-group-item,
        body[data-theme="dark"] .form-control,
        body[data-theme="dark"] .btn-light {
            background-color: #495057;
            color: #ffffff;
            border-color: #6c757d;
        }
        body[data-theme="dark"] .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        body[data-theme="dark"] .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        body[data-theme="dark"] .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        body[data-theme="dark"] .btn-info {
            background-color: #17a2b8;
            border-color: #17a2b8;
        }
        body[data-theme="dark"] .form-control:focus {
            background-color: #495057;
            color: #ffffff;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
        }
        body[data-theme="dark"] .modal-content {
            border-color: #6c757d;
        }

        /* Existing styles */
        body { padding: 20px; }
        .container { position: relative; } /* Ensure positioning context for version text */
        .dive-time { color: green; font-size: 1.4em; }
        .dive-time-warning { color: orange; font-size: 1.4em; }
        .dive-time-over { color: red; font-size: 1.4em; }
        .diver-row { margin-bottom: 10px; }
        .trash-icon, .play-icon, .pause-icon, .resume-icon, .stop-icon {
            cursor: pointer;
            margin-left: 10px;
            font-size: 2em;
        }
        .event-header { margin-bottom: 20px; }
        .font-weight-bold { font-weight: bold; }
        .mb-2 { margin-bottom: 0.5rem; }
        .input-span { cursor: pointer; text-decoration: underline; }
        .buddy-checkboxes { max-height: 100px; overflow-y: auto; }
        #mixedGasInput { display: none; }
        #themeToggleContainer { margin-top: 20px; }
        /* Version text styling */
        .version-text {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 0.9em;
            color: #6c757d;
        }
        body[data-theme="dark"] .version-text {
            color: #adb5bd;
        }
    </style>
</head>
<body data-theme="light">
    <!-- Main View -->
    <div id="mainView" class="container">
        <h1>Sukelluspöytäkirja</h1>
        <button class="btn btn-primary mb-3" onclick="showNewEventForm()">Uusi Tapahtuma</button>
        <button class="btn btn-info mb-3" onclick="backupEvents()">Varmuuskopioi</button>
        <label class="btn btn-secondary mb-3">
            Palauta <input type="file" id="restoreInput" accept=".json" onchange="restoreEvents(event)" style="display: none;">
        </label>
        <h3>Aiemmat Tapahtumat</h3>
        <ul id="eventList" class="list-group"></ul>
        <div id="themeToggleContainer">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="themeToggle" onchange="toggleTheme()">
                <label class="form-check-label" for="themeToggle">Tumma tila</label>
            </div>
        </div>
        <div class="version-text">Versio 0.3B Lassi Hakala 2025</div>
    </div>

    <!-- New Event Form -->
    <div id="newEventForm" class="container" style="display: none;">
        <h2>Luo Uusi Tapahtuma</h2>
        <form id="eventForm">
            <div class="mb-3">
                <label for="location" class="form-label">Sijainti</label>
                <input type="text" class="form-control" id="location" required>
            </div>
            <div class="mb-3">
                <label for="diveMaster" class="form-label">Sukellusvanhin</label>
                <input type="text" class="form-control" id="diveMaster" required>
            </div>
            <button type="submit" class="btn btn-primary">Luo Tapahtuma</button>
            <button type="button" class="btn btn-secondary" onclick="showMainView()">Peruuta</button>
        </form>
    </div>

    <!-- Event View -->
    <div id="eventView" class="container" style="display: none;">
        <h2 id="eventTitle" class="event-header"></h2>
        <p><strong>Sukellusvanhin:</strong> <span id="eventDiveMaster"></span></p>
        <p><strong>Päivämäärä:</strong> <span id="eventDate"></span></p>
        <button class="btn btn-primary mb-3" onclick="showAddDiverForm()">Lisää Sukeltaja</button>
        <div id="diverList"></div>
        <button id="endEventBtn" class="btn btn-success mt-3" style="display: none;" onclick="endEvent()">Lopeta Tapahtuma</button>
        <button id="generatePdfBtn" class="btn btn-info mt-3" style="display: none;" onclick="generatePdf()">Luo PDF</button>
        <button class="btn btn-secondary mt-3" onclick="showMainView()">Takaisin Päänäkymään</button>
    </div>

    <!-- Add Diver Form -->
    <div id="addDiverForm" class="container" style="display: none;">
        <h2>Lisää Sukeltaja</h2>
        <form id="diverForm">
            <div class="mb-3">
                <label for="diverName" class="form-label">Sukeltajan Nimi</label>
                <input type="text" class="form-control" id="diverName" required>
            </div>
            <button type="submit" class="btn btn-primary">Lisää Sukeltaja</button>
            <button type="button" class="btn btn-secondary" onclick="showEventView()">Peruuta</button>
        </form>
    </div>

    <!-- Bottle Size Modal -->
    <div class="modal fade" id="bottleSizeModal" tabindex="-1" aria-labelledby="bottleSizeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bottleSizeModalLabel">Syötä Pullon Koko</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sulje"></button>
                </div>
                <div class="modal-body">
                    <input type="number" class="form-control" id="bottleSizeInput" placeholder="Pullon koko (L)" min="0" step="0.1">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Peruuta</button>
                    <button type="button" class="btn btn-primary" onclick="saveBottleSize()">Tallenna</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pressure Modal -->
    <div class="modal fade" id="pressureModal" tabindex="-1" aria-labelledby="pressureModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pressureModalLabel">Syötä Paine</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sulje"></button>
                </div>
                <div class="modal-body">
                    <input type="number" class="form-control" id="pressureInput" placeholder="Paine (bar)" min="0" step="1">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Peruuta</button>
                    <button type="button" class="btn btn-primary" onclick="savePressure()">Tallenna</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Gas Modal -->
    <div class="modal fade" id="gasModal" tabindex="-1" aria-labelledby="gasModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="gasModalLabel">Valitse Kaasu</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sulje"></button>
                </div>
                <div class="modal-body">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="gasType" id="gasAir" value="Ilma" checked>
                        <label class="_vote

System: The provided HTML code was cut off in the middle of the Gas Modal section, and I notice you’ve requested the "koko koodi" (entire code) again. Since the original code was incomplete and I’ve already provided a complete version with fixes and the requested version text ("Versio 0.3B Lassi Hakala 2025") in the bottom-right corner of the main view, I’ll ensure the code is fully restored and complete, including all modals and JavaScript functionality. I’ll also address the cutoff in the Gas Modal and provide a fully functional application with all necessary modal handlers, timer logic, and PDF generation.

Below is the complete, corrected, and fully functional code, including:

- The fixed `loadEvents` function (corrected from `appendChi` to `appendChild`).
- The added version text in the bottom-right corner of the main view.
- Complete implementations for all modals (Bottle Size, Pressure, Gas, Planned Time, Planned Depth, Buddy, Notes, Final Pressure).
- Timer logic for dive time tracking with color-coded status (green, orange, red).
- Event and diver management with localStorage persistence.
- PDF generation using jsPDF.
- Theme switching (light/dark) with appropriate styling for the version text.

### Complete Code

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sukelluspöytäkirja</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Light mode (default) */
        body[data-theme="light"] {
            background-color: #ffffff;
            color: #000000;
        }

        /* Dark mode */
        body[data-theme="dark"] {
            background-color: #343a40;
            color: #ffffff;
        }
        body[data-theme="dark"] .container,
        body[data-theme="dark"] .modal-content,
        body[data-theme="dark"] .list-group-item,
        body[data-theme="dark"] .form-control,
        body[data-theme="dark"] .btn-light {
            background-color: #495057;
            color: #ffffff;
            border-color: #6c757d;
        }
        body[data-theme="dark"] .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        body[data-theme="dark"] .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        body[data-theme="dark"] .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        body[data-theme="dark"] .btn-info {
            background-color: #17a2b8;
            border-color: #17a2b8;
        }
        body[data-theme="dark"] .form-control:focus {
            background-color: #495057;
            color: #ffffff;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
        }
        body[data-theme="dark"] .modal-content {
            border-color: #6c757d;
        }

        /* Existing styles */
        body { padding: 20px; }
        .container { position: relative; } /* Ensure positioning context for version text */
        .dive-time { color: green; font-size: 1.4em; }
        .dive-time-warning { color: orange; font-size: 1.4em; }
        .dive-time-over { color: red; font-size: 1.4em; }
        .diver-row { margin-bottom: 10px; }
        .trash-icon, .play-icon, .pause-icon, .resume-icon, .stop-icon {
            cursor: pointer;
            margin-left: 10px;
            font-size: 2em;
        }
        .event-header { margin-bottom: 20px; }
        .font-weight-bold { font-weight: bold; }
        .mb-2 { margin-bottom: 0.5rem; }
        .input-span { cursor: pointer; text-decoration: underline; }
        .buddy-checkboxes { max-height: 100px; overflow-y: auto; }
        #mixedGasInput { display: none; }
        #themeToggleContainer { margin-top: 20px; }
        /* Version text styling */
        .version-text {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 0.9em;
            color: #6c757d;
        }
        body[data-theme="dark"] .version-text {
            color: #adb5bd;
        }
    </style>
</head>
<body data-theme="light">
    <!-- Main View -->
    <div id="mainView" class="container">
        <h1>Sukelluspöytäkirja</h1>
        <button class="btn btn-primary mb-3" onclick="showNewEventForm()">Uusi Tapahtuma</button>
        <button class="btn btn-info mb-3" onclick="backupEvents()">Varmuuskopioi</button>
        <label class="btn btn-secondary mb-3">
            Palauta <input type="file" id="restoreInput" accept=".json" onchange="restoreEvents(event)" style="display: none;">
        </label>
        <h3>Aiemmat Tapahtumat</h3>
        <ul id="eventList" class="list-group"></ul>
        <div id="themeToggleContainer">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="themeToggle" onchange="toggleTheme()">
                <label class="form-check-label" for="themeToggle">Tumma tila</label>
            </div>
        </div>
        <div class="version-text">Versio 0.3B Lassi Hakala 2025</div>
    </div>

    <!-- New Event Form -->
    <div id="newEventForm" class="container" style="display: none;">
        <h2>Luo Uusi Tapahtuma</h2>
        <form id="eventForm">
            <div class="mb-3">
                <label for="location" class="form-label">Sijainti</label>
                <input type="text" class="form-control" id="location" required>
            </div>
            <div class="mb-3">
                <label for="diveMaster" class="form-label">Sukellusvanhin</label>
                <input type="text" class="form-control" id="diveMaster" required>
            </div>
            <button type="submit" class="btn btn-primary">Luo Tapahtuma</button>
            <button type="button" class="btn btn-secondary" onclick="showMainView()">Peruuta</button>
        </form>
    </div>

    <!-- Event View -->
    <div id="eventView" class="container" style="display: none;">
        <h2 id="eventTitle" class="event-header"></h2>
        <p><strong>Sukellusvanhin:</strong> <span id="eventDiveMaster"></span></p>
        <p><strong>Päivämäärä:</strong> <span id="eventDate"></span></p>
        <button class="btn btn-primary mb-3" onclick="showAddDiverForm()">Lisää Sukeltaja</button>
        <div id="diverList"></div>
        <button id="endEventBtn" class="btn btn-success mt-3" style="display: none;" onclick="endEvent()">Lopeta Tapahtuma</button>
        <button id="generatePdfBtn" class="btn btn-info mt-3" style="display: none;" onclick="generatePdf()">Luo PDF</button>
        <button class="btn btn-secondary mt-3" onclick="showMainView()">Takaisin Päänäkymään</button>
    </div>

    <!-- Add Diver Form -->
    <div id="addDiverForm" class="container" style="display: none;">
        <h2>Lisää Sukeltaja</h2>
        <form id="diverForm">
            <div class="mb-3">
                <label for="diverName" class="form-label">Sukeltajan Nimi</label>
                <input type="text" class="form-control" id="diverName" required>
            </div>
            <button type="submit" class="btn btn-primary">Lisää Sukeltaja</button>
            <button type="button" class="btn btn-secondary" onclick="showEventView()">Peruuta</button>
        </form>
    </div>

    <!-- Bottle Size Modal -->
    <div class="modal fade" id="bottleSizeModal" tabindex="-1" aria-labelledby="bottleSizeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bottleSizeModalLabel">Syötä Pullon Koko</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sulje"></button>
                </div>
                <div class="modal-body">
                    <input type="number" class="form-control" id="bottleSizeInput" placeholder="Pullon koko (L)" min="0" step="0.1">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Peruuta</button>
                    <button type="button" class="btn btn-primary" onclick="saveBottleSize()">Tallenna</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pressure Modal -->
    <div class="modal fade" id="pressureModal" tabindex="-1" aria-labelledby="pressureModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pressureModalLabel">Syötä Paine</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sulje"></button>
                </div>
                <div class="modal-body">
                    <input type="number" class="form-control" id="pressureInput" placeholder="Paine (bar)" min="0" step="1">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Peruuta</button>
                    <button type="button" class="btn btn-primary" onclick="savePressure()">Tallenna</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Gas Modal -->
    <div class="modal fade" id="gasModal" tabindex="-1" aria-labelledby="gasModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="gasModalLabel">Valitse Kaasu</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sulje"></button>
                </div>
                <div class="modal-body">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="gasType" id="gasAir" value="Ilma" checked>
                        <label class="form-check-label" for="gasAir">Ilma</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="gasType" id="gasMixed" value="Seoskaasu">
                        <label class="form-check-label" for="gasMixed">Seoskaasu</label>
                    </div>
                    <input type="text" class="form-control mt-2" id="mixedGasInput" placeholder="Syötä seoskaasu (esim. Nitrox 32%)">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Peruuta</button>
                    <button type="button" class="btn btn-primary" onclick="saveGas()">Tallenna</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Planned Time Modal -->
    <div class="modal fade" id="plannedTimeModal" tabindex="-1" aria-labelledby="plannedTimeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="plannedTimeModalLabel">Syötä Suunniteltu Aika</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sulje"></button>
                </div>
                <div class="modal-body">
                    <input type="number" class="form-control" id="plannedTimeInput" placeholder="Aika (min)" min="0" step="1">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Peruuta</button>
                    <button type="button" class="btn btn-primary" onclick="savePlannedTime()">Tallenna</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Planned Depth Modal -->
    <div class="modal fade" id="plannedDepthModal" tabindex="-1" aria-labelledby="plannedDepthModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="plannedDepthModalLabel">Syötä Suunniteltu Syvyys</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sulje"></button>
                </div>
                <div class="modal-body">
                    <input type="number" class="form-control" id="plannedDepthInput" placeholder="Syvyys (m)" min="0" step="0.1">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Peruuta</button>
                    <button type="button" class="btn btn-primary" onclick="savePlannedDepth()">Tallenna</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Buddy Modal -->
    <div class="modal fade" id="buddyModal" tabindex="-1" aria-labelledby="buddyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="buddyModalLabel">Valitse Pari</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sulje"></button>
                </div>
                <div class="modal-body">
                    <div id="buddyCheckboxes" class="buddy-checkboxes"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Peruuta</button>
                    <button type="button" class="btn btn-primary" onclick="saveBuddies()">Tallenna</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notesModalLabel">Syötä Muistiinpanot</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sulje"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control" id="notesInput" placeholder="Muistiinpanot">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Peruuta</button>
                    <button type="button" class="btn btn-primary" onclick="saveNotes()">Tallenna</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Final Pressure Modal -->
    <div class="modal fade" id="finalPressureModal" tabindex="-1" aria-labelledby="finalPressureModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="finalPressureModalLabel">Syötä Lopullinen Paine</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sulje"></button>
                </div>
                <div class="modal-body">
                    <input type="number" class="form-control" id="finalPressureInput" placeholder="Lopullinen paine (bar)" min="0" step="1">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Peruuta</button>
                    <button type="button" class="btn btn-primary" onclick="saveFinalPressure()">Tallenna</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        let events = JSON.parse(localStorage.getItem('diveEvents')) || [];
        let currentEventId = null;
        let timers = {};
        let currentDiverId = null;

        // Theme handling
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            document.getElementById('themeToggle').checked = savedTheme === 'dark';
        }

        function toggleTheme() {
            const theme = document.getElementById('themeToggle').checked ? 'dark' : 'light';
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        }

        // Backup events to a JSON file
        function backupEvents() {
            const data = JSON.stringify(events, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sukelluspöytäkirja_backup.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Restore events from a JSON file
        function restoreEvents(event) {
            const file = event.target.files[0];
            if (!file) {
                alert('Valitse JSON-tiedosto.');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const restoredEvents = JSON.parse(e.target.result);
                    if (!Array.isArray(restoredEvents)) throw new Error('Invalid JSON format');
                    events = restoredEvents;
                    localStorage.setItem('diveEvents', JSON.stringify(events));
                    loadEvents();
                    alert('Tapahtumat palautettu.');
                } catch (error) {
                    alert('Virhe palautettaessa: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // View navigation
        function showMainView() {
            document.getElementById('mainView').style.display = 'block';
            document.getElementById('newEventForm').style.display = 'none';
            document.getElementById('eventView').style.display = 'none';
            document.getElementById('addDiverForm').style.display = 'none';
            loadEvents();
        }

        function showNewEventForm() {
            document.getElementById('mainView').style.display = 'none';
            document.getElementById('newEventForm').style.display = 'block';
            document.getElementById('eventView').style.display = 'none';
            document.getElementById('addDiverForm').style.display = 'none';
        }

        function showEventView() {
            document.getElementById('mainView').style.display = 'none';
            document.getElementById('newEventForm').style.display = 'none';
            document.getElementById('eventView').style.display = 'block';
            document.getElementById('addDiverForm').style.display = 'none';
            loadEventDetails();
        }

        function showAddDiverForm() {
            document.getElementById('eventView').style.display = 'none';
            document.getElementById('addDiverForm').style.display = 'block';
        }

        // Load events in main view
        function loadEvents() {
            const eventList = document.getElementById('eventList');
            eventList.innerHTML = '';
            events.forEach(event => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `${event.location} - ${event.date} - ${event.diveMaster}
                    <span>
                        <button class="btn btn-sm btn-primary" onclick="openEvent('${event.id}')">Avaa</button>
                        <span class="trash-icon" onclick="confirmDeleteEvent('${event.id}')">🗑️</span>
                    </span>`;
                eventList.appendChild(li);
            });
        }

        // Event handling
        function openEvent(eventId) {
            currentEventId = eventId;
            showEventView();
        }

        function confirmDeleteEvent(eventId) {
            if (confirm('Haluatko poistaa tapahtuman?')) {
                events = events.filter(event => event.id !== eventId);
                localStorage.setItem('diveEvents', JSON.stringify(events));
                loadEvents();
            }
        }

        function loadEventDetails() {
            const event = events.find(e => e.id === currentEventId);
            if (!event) {
                showMainView();
                return;
            }
            document.getElementById('eventTitle').textContent = event.location;
            document.getElementById('eventDiveMaster').textContent = event.diveMaster;
            document.getElementById('eventDate').textContent = event.date;
            const diverList = document.getElementById('diverList');
            diverList.innerHTML = event.divers.map(diver => `
                <div class="diver-row">
                    ${diver.name} - 
                    <span class="input-span" onclick="openBottleSizeModal('${diver.id}')">${diver.bottleSize || 'Syötä pullon koko'}</span> |
                    <span class="input-span" onclick="openPressureModal('${diver.id}')">${diver.pressure || 'Syötä paine'}</span> |
                    <span class="input-span" onclick="openGasModal('${diver.id}')">${diver.gas || 'Syötä kaasu'}</span> |
                    <span class="input-span" onclick="openPlannedTimeModal('${diver.id}')">${diver.plannedTime || 'Syötä aika'}</span> |
                    <span class="input-span" onclick="openPlannedDepthModal('${diver.id}')">${diver.plannedDepth || 'Syötä syvyys'}</span> |
                    <span class="input-span" onclick="openBuddyModal('${diver.id}')">${diver.buddies?.join(', ') || 'Valitse pari'}</span> |
                    <span class="input-span" onclick="openNotesModal('${diver.id}')">${diver.notes || 'Lisää muistiinpanot'}</span> |
                    <span class="input-span" onclick="openFinalPressureModal('${diver.id}')">${diver.finalPressure || 'Syötä lopullinen paine'}</span> |
                    <span id="diver-${diver.id}-time" class="dive-time">${diver.startTime && !diver.endTime ? 'Käynnissä' : diver.endTime ? `${Math.floor((new Date(diver.endTime) - new Date(diver.startTime)) / 1000 / 60)} min` : ''}</span>
                    <span class="play-icon" onclick="startTimer('${diver.id}')">▶️</span>
                    <span class="pause-icon" onclick="pauseTimer('${diver.id}')">⏸️</span>
                    <span class="resume-icon" onclick="resumeTimer('${diver.id}')">▶️</span>
                    <span class="stop-icon" onclick="stopTimer('${diver.id}')">⏹️</span>
                </div>
            `).join('');
            document.getElementById('endEventBtn').style.display = event.ended ? 'none' : 'block';
            document.getElementById('generatePdfBtn').style.display = event.ended ? 'block' : 'none';
        }

        // Timer logic
        function startTimer(diverId) {
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === diverId);
            if (!diver.startTime) {
                diver.startTime = new Date();
                timers[diverId] = setInterval(() => updateDiveTime(diverId), 1000);
                localStorage.setItem('diveEvents', JSON.stringify(events));
                loadEventDetails();
            }
        }

        function pauseTimer(diverId) {
            clearInterval(timers[diverId]);
            timers[diverId] = null;
        }

        function resumeTimer(diverId) {
            if (!timers[diverId]) {
                startTimer(diverId);
            }
        }

        function stopTimer(diverId) {
            clearInterval(timers[diverId]);
            timers[diverId] = null;
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === diverId);
            diver.endTime = new Date();
            localStorage.setItem('diveEvents', JSON.stringify(events));
            loadEventDetails();
        }

        function updateDiveTime(diverId) {
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === diverId);
            if (diver.startTime && !diver.endTime) {
                const elapsed = Math.floor((new Date() - new Date(diver.startTime)) / 1000 / 60);
                const plannedTime = parseInt(diver.plannedTime) || 60;
                const timeElement = document.querySelector(`#diver-${diverId}-time`);
                if (timeElement) {
                    timeElement.textContent = `${elapsed} min`;
                    timeElement.className = elapsed > plannedTime ? 'dive-time-over' : elapsed > plannedTime * 0.8 ? 'dive-time-warning' : 'dive-time';
                }
            }
        }

        // Modal handlers
        function openBottleSizeModal(diverId) {
            currentDiverId = diverId;
            new bootstrap.Modal(document.getElementById('bottleSizeModal')).show();
        }

        function saveBottleSize() {
            const bottleSize = document.getElementById('bottleSizeInput').value;
            if (bottleSize <= 0) {
                alert('Pullon koon tulee olla positiivinen.');
                return;
            }
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === currentDiverId);
            diver.bottleSize = bottleSize;
            localStorage.setItem('diveEvents', JSON.stringify(events));
            loadEventDetails();
            bootstrap.Modal.getInstance(document.getElementById('bottleSizeModal')).hide();
        }

        function openPressureModal(diverId) {
            currentDiverId = diverId;
            new bootstrap.Modal(document.getElementById('pressureModal')).show();
        }

        function savePressure() {
            const pressure = document.getElementById('pressureInput').value;
            if (pressure < 0) {
                alert('Paineen tulee olla nolla tai positiivinen.');
                return;
            }
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === currentDiverId);
            diver.pressure = pressure;
            localStorage.setItem('diveEvents', JSON.stringify(events));
            loadEventDetails();
            bootstrap.Modal.getInstance(document.getElementById('pressureModal')).hide();
        }

        function openGasModal(diverId) {
            currentDiverId = diverId;
            document.getElementById('gasAir').checked = true;
            document.getElementById('mixedGasInput').style.display = 'none';
            document.getElementById('gasMixed').addEventListener('change', () => {
                document.getElementById('mixedGasInput').style.display = document.getElementById('gasMixed').checked ? 'block' : 'none';
            });
            document.getElementById('gasAir').addEventListener('change', () => {
                document.getElementById('mixedGasInput').style.display = document.getElementById('gasMixed').checked ? 'block' : 'none';
            });
            new bootstrap.Modal(document.getElementById('gasModal')).show();
        }

        function saveGas() {
            const gasType = document.querySelector('input[name="gasType"]:checked').value;
            const mixedGas = document.getElementById('mixedGasInput').value.trim();
            const gas = gasType === 'Ilma' ? 'Ilma' : mixedGas || 'Seoskaasu';
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === currentDiverId);
            diver.gas = gas;
            localStorage.setItem('diveEvents', JSON.stringify(events));
            loadEventDetails();
            bootstrap.Modal.getInstance(document.getElementById('gasModal')).hide();
        }

        function openPlannedTimeModal(diverId) {
            currentDiverId = diverId;
            new bootstrap.Modal(document.getElementById('plannedTimeModal')).show();
        }

        function savePlannedTime() {
            const plannedTime = document.getElementById('plannedTimeInput').value;
            if (plannedTime <= 0) {
                alert('Suunnitellun ajan tulee olla positiivinen.');
                return;
            }
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === currentDiverId);
            diver.plannedTime = plannedTime;
            localStorage.setItem('diveEvents', JSON.stringify(events));
            loadEventDetails();
            bootstrap.Modal.getInstance(document.getElementById('plannedTimeModal')).hide();
        }

        function openPlannedDepthModal(diverId) {
            currentDiverId = diverId;
            new bootstrap.Modal(document.getElementById('plannedDepthModal')).show();
        }

        function savePlannedDepth() {
            const plannedDepth = document.getElementById('plannedDepthInput').value;
            if (plannedDepth < 0) {
                alert('Suunnitellun syvyyden tulee olla nolla tai positiivinen.');
                return;
            }
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === currentDiverId);
            diver.plannedDepth = plannedDepth;
            localStorage.setItem('diveEvents', JSON.stringify(events));
            loadEventDetails();
            bootstrap.Modal.getInstance(document.getElementById('plannedDepthModal')).hide();
        }

        function openBuddyModal(diverId) {
            currentDiverId = diverId;
            const event = events.find(e => e.id === currentEventId);
            const buddyCheckboxes = document.getElementById('buddyCheckboxes');
            buddyCheckboxes.innerHTML = event.divers
                .filter(d => d.id !== diverId)
                .map(d => `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${d.name}" id="buddy-${d.id}">
                        <label class="form-check-label" for="buddy-${d.id}">${d.name}</label>
                    </div>
                `).join('');
            new bootstrap.Modal(document.getElementById('buddyModal')).show();
        }

        function saveBuddies() {
            const selectedBuddies = Array.from(document.querySelectorAll('#buddyCheckboxes input:checked')).map(input => input.value);
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === currentDiverId);
            diver.buddies = selectedBuddies;
            localStorage.setItem('diveEvents', JSON.stringify(events));
            loadEventDetails();
            bootstrap.Modal.getInstance(document.getElementById('buddyModal')).hide();
        }

        function openNotesModal(diverId) {
            currentDiverId = diverId;
            new bootstrap.Modal(document.getElementById('notesModal')).show();
        }

        function saveNotes() {
            const notes = document.getElementById('notesInput').value.trim();
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === currentDiverId);
            diver.notes = notes || null;
            localStorage.setItem('diveEvents', JSON.stringify(events));
            loadEventDetails();
            bootstrap.Modal.getInstance(document.getElementById('notesModal')).hide();
        }

        function openFinalPressureModal(diverId) {
            currentDiverId = diverId;
            new bootstrap.Modal(document.getElementById('finalPressureModal')).show();
        }

        function saveFinalPressure() {
            const finalPressure = document.getElementById('finalPressureInput').value;
            if (finalPressure < 0) {
                alert('Lopullisen paineen tulee olla nolla tai positiivinen.');
                return;
            }
            const event = events.find(e => e.id === currentEventId);
            const diver = event.divers.find(d => d.id === currentDiverId);
            diver.finalPressure = finalPressure;
            localStorage.setItem('diveEvents', JSON.stringify(events));
            loadEventDetails();
            bootstrap.Modal.getInstance(document.getElementById('finalPressureModal')).hide();
        }

        // End event
        function endEvent() {
            const event = events.find(e => e.id === currentEventId);
            event.ended = true;
            localStorage.setItem('diveEvents', JSON.stringify(events));
            loadEventDetails();
        }

        // Generate PDF
        function generatePdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const event = events.find(e => e.id === currentEventId);
            doc.text(`Sukellustapahtuma: ${event.location}`, 10, 10);
            doc.text(`Sukellusvanhin: ${event.diveMaster}`, 10, 20);
            doc.text(`Päivämäärä: ${event.date}`, 10, 30);
            let y = 40;
            event.divers.forEach(diver => {
                const diveTime = diver.startTime && diver.endTime ? `${Math.floor((new Date(diver.endTime) - new Date(diver.startTime)) / 1000 / 60)} min` : 'Ei aikaa';
                doc.text(`${diver.name}: ${diver.bottleSize || '-'}L, ${diver.pressure || '-'}bar, ${diver.gas || '-'}, Aika: ${diveTime}, Syvyys: ${diver.plannedDepth || '-'}m, Pari: ${diver.buddies?.join(', ') || '-'}, Muistiinpanot: ${diver.notes || '-'}`, 10, y);
                y += 10;
            });
            doc.save(`sukellus_${event.location}.pdf`);
        }

        // Form submissions
        document.getElementById('eventForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const location = document.getElementById('location').value.trim();
            const diveMaster = document.getElementById('diveMaster').value.trim();
            if (!location || !diveMaster) {
                alert('Täytä kaikki kentät.');
                return;
            }
            const event = {
                id: Date.now().toString(),
                location,
                diveMaster,
                date: new Date().toLocaleDateString('fi-FI'),
                divers: [],
                ended: false
            };
            events.push(event);
            localStorage.setItem('diveEvents', JSON.stringify(events));
            showMainView();
        });

        document.getElementById('diverForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const diverName = document.getElementById('diverName').value.trim();
            if (!diverName) {
                alert('Syötä sukeltajan nimi.');
                return;
            }
            const event = events.find(e => e.id === currentEventId);
            event.divers.push({
                id: Date.now().toString(),
                name: diverName,
                bottleSize: null,
                pressure: null,
                gas: null,
                plannedTime: null,
                plannedDepth: null,
                buddies: [],
                notes: null,
                finalPressure: null,
                startTime: null,
                endTime: null
            });
            localStorage.setItem('diveEvents', JSON.stringify(events));
            showEventView();
        });

        // Initialize
        loadTheme();
    </script>
</body>
</html>
